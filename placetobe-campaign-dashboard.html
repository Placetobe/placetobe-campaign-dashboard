<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../placetobe-styles/placetobe-styles.html">
<link rel="import" href="../placetobe-styles/placetobe-dashboard-styles.html">

<link rel="import" href="../caas-auth-behavior/caas-auth-behavior.html">
<link rel="import" href="../placetobe-signin-card/placetobe-signin-card.html">
<link rel="import" href="../placetobe-card/placetobe-card.html">
<link rel="import" href="../placetobe-input-box/placetobe-input-box.html">
<link rel="import" href="../placetobe-select-box/placetobe-select-box.html">
<link rel="import" href="../placetobe-textarea-box/placetobe-textarea-box.html">
<link rel="import" href="../placetobe-campaign-stats-card/placetobe-campaign-stats-card.html">
<link rel="import" href="../placetobe-button/placetobe-button.html">
<link rel="import" href="../placetobe-campaign-page/placetobe-campaign-page.html">

<link rel="import" href="../placetobe-navigation-bar/placetobe-navigation-bar.html">

<link rel="import" href="can-api/can-api.html">


<script src="../moment/moment.js"></script>
<link rel="import" href="../google-youtube/google-youtube.html">
<link rel="import" href="../vimeo-video/vimeo-video.html">
<link rel="import" href="../silk-editor/silk-editor.html">
<link rel="import" href="../caas-campaign-types/caas-campaign-types.html">

<link rel="import" href="can-user-session/can-user-session.html">
<link rel="import" href="can-login-page/can-login-page.html">
<link rel="import" href="can-form/can-form.html">
<link rel="import" href="can-textinput/can-textinput.html">
<link rel="import" href="can-textarea/can-textarea.html">
<link rel="import" href="can-campaign-categories-list/can-campaign-categories-list.html">
<link rel="import" href="can-campaign-cover-form/can-campaign-cover-form.html">
<link rel="import" href="can-user-profile-form/can-user-profile-form.html">
<link rel="import" href="can-campaign-id-form/can-campaign-id-form.html">
<link rel="import" href="can-campaign-kvk-form/can-campaign-kvk-form.html">
<link rel="import" href="can-campaign-contract-form/can-campaign-contract-form.html">
<link rel="import" href="can-campaign-incentives-form/can-campaign-incentives-form.html">
<link rel="import" href="can-contracts-table/can-contracts-table.html">
<link rel="import" href="can-overlay/can-overlay.html">
<link rel="import" href="can-loader/can-loader.html">
<link rel="import" href="can-switch-button/can-switch-button.html">
<link rel="import" href="can-campaign-repayments-card/can-campaign-repayments-card.html">
<link rel="import" href="can-file-io/can-file-io.html">
<link rel="import" href="can-location-selector/can-location-selector.html">
<link rel="import" href="can-campaign-location-card/can-campaign-location-card.html">
<!--
`placetobe-campaign-dashboard`
Placetobe dashboard for campaigns

@demo demo/index.html
-->

<dom-module id="placetobe-campaign-dashboard">
	<template>
		<style include="placetobe-dashboard-styles">
			[hidden] {
      display: none!important;
    }

    :host img {
      max-width: 100%;
    }

    placetobe-card ul {
      text-align: left;
    }

    li[data-completed]:before {
      content: '';
      border-radius: 50%;
      width: var(--placetobe-margin);
      height: var(--placetobe-margin);
      background-color: var(--placetobe-color-green);
      box-sizing: border-box;
      margin-right: 8px;
      margin-top: 4px;
      display: inline-block;
    }

    li[data-uncomplete]:before {
      content: '';
      border-radius: 50%;
      width: var(--placetobe-margin);
      height: var(--placetobe-margin);
      background-color: var(--placetobe-color-red);
      box-sizing: border-box;
      margin-right: 8px;
      margin-top: 4px;
      display: inline-block;
    }

    silk-editor {
      width: 600px;
      max-width: 100%;
      height: 70vh;
      padding-top: 50px;
      box-sizing: border-box;
    }
    </style>

		<placetobe-signin-card hidden$="[[signedIn]]" id="signInCard" api-endpoint="[[apiEndpoint]]" signed-in="{{signedIn}}"
		 access-token="{{accessToken}}" user-role="ondernemer"></placetobe-signin-card>

		<template is="dom-if" if="[[signedIn]]" restamp="true">

			<can-api
				auth
				active-role="entrepreneur"
				id="getCampaignAdministrators"
				auto="[[entrepreneurId]]"
				route="entrepreneurs/[[entrepreneurId]]/campaignadministrators"
				method="GET"
				last-response="{{campaignAdministrators}}"
				access-token="{{accessToken}}"
				api-endpoint="[[apiEndpoint]]"
			></can-api>
			
			<can-api 
				auth 
				active-role="entrepreneur" 
				id="campaignAjax" 
				auto="[[campaignId]]"
				route="entrepreneurs/[[campaignId]]"
				method="GET" 
				last-response="{{campaign}}"
				access-token="[[accessToken]]"
				api-endpoint="[[apiEndpoint]]">
			</can-api>
			

			<placetobe-navigation-bar>
				<li slot="navigation">Dashboard Ondernemers</li>
				<placetobe-button slot="footer" on-tap="signOut">Uitloggen</placetobe-button>
			</placetobe-navigation-bar>

			<header>
				<h1>[[campaign.projectNaam]]</h1>
				<h2>Welkom. Hier kun je je campagne beheren en de contracten met je investeerders inzien.</h2>

				<iron-selector slot="footer" selected="{{selectedTab}}" attr-for-selected="data-name">
					<placetobe-button link data-name="story">Verhaal</placetobe-button>
					<placetobe-button link data-name="finance">Financieel</placetobe-button>
					<placetobe-button link data-name="details">Gegevens</placetobe-button>
					<placetobe-button link data-name="incentives">Beloningen</placetobe-button>
					<placetobe-button link data-name="investments">Investeringen</placetobe-button>
					<placetobe-button link data-name="preview">Voorvertoning</placetobe-button>
				</iron-selector>

			</header>

			<main>
				<div>
					<!-- tabs /-->

					<!-- details -->
					<template is="dom-if" if="[[_selectedTabEquals(selectedTab, 'story')]]">

						<article>
							<p>Ben je er klaar voor? Begin dan met de aankleding van je campagnepagina!</p>
						</article>

						<placetobe-card title="Basics">
							<div slot="main">
								<article>

									<p>First things first. Wat is de kern van je campagne?</p>

									<can-form 
										auth
										active-role="entrepreneur" 
										access-token="{{accessToken}}" 
										api-endpoint="[[apiEndpoint]]"
										disabled$="[[!editable]]"
										disabled-warning="[[notEditableWarning]]" 
										apipath="entrepreneurs/[[campaign.id]]/basics"
										access-token="{{accessToken}}" 
										api-endpoint="[[apiEndpoint]]" 
										formdata="[[campaign]]" 
										id="basics-form"
										on-error="handleBasicsError" 
										method="put" 
										valid="{{basicsCompleted}}">

										<placetobe-input-box name="projectnaam" value="{{campaign.projectNaam}}" placeholder="Projectnaam" pattern=".+"
										 tip="Hoe gaat je project heten? Dit hoeft niet gelijk te zijn aan je bedrijfsnaam. Idealiter heeft jouw campagnenaam niet meer dan 3 woorden."
										 required></placetobe-input-box>
										<placetobe-textarea-box name="teaser op campagneoverzicht" value="{{campaign.teaser}}" placeholder="Teaser op campagneoverzicht"
										 description="Verleid bezoekers om naar je pagina te gaan. Deze teaser komt op de overzichtenpagina te staan. (max. 140 tekens)"
										 maxlength="140" minlength="0" required></placetobe-textarea-box>
										<placetobe-textarea-box name="introductie Tekst" value="{{campaign.introductieTekst}}" placeholder="lead boven aan je pagina"
										 description="Zeg in 400 tekens wie je bent, wat je doet en wat je met de campagne wil. Dit komt boven aan je tekst te staan."
										 maxlength="400" minlength="0" required></placetobe-textarea-box>

									</can-form>

								</article>
							</div>
						</placetobe-card>

						<placetobe-card title="Video">
							<div slot="main">
								<article>
									<p>Trek aandacht met een video. Zo laat je zien wie je bent en wat je plan is.</p>

									<can-form 
										auth
										active-role="entrepreneur"
										access-token="{{accessToken}}" 
										api-endpoint="[[apiEndpoint]]"
										disabled$="[[!editable]]"
									 	disabled-warning="[[notEditableWarning]]"
									  	apipath="entrepreneurs/[[campaign.id]]/videourl"
									   	formdata="[[campaign.video]]"
									   	id="videourl-form" 
									   	method="put" 
									   	valid="{{videoCompleted}}">

										<placetobe-input-box name="video url" value="{{campaign.video.url}}" placeholder="Vul hier de link naar je video op YouTube of Vimeo in"
										 tip="Mensen leren je kennen via video. Dus hoe persoonlijker het filmpje, hoe beter het is voor je campagne."></placetobe-input-box>

										<template is="dom-if" if="[[campaign.video.youtube.id]]" restamp="true">
											<google-youtube video-id="[[campaign.video.youtube.id]]" width="100%" height="400px" rel="0" start="0"
											 autoplay="false" modestbranding="1" showinfo="0" iv_load_policy="3" rel="0"></google-youtube>
										</template>

										<template is="dom-if" if="[[campaign.video.vimeo.id]]" restamp="true">
											<vimeo-video video-id="[[campaign.video.vimeo.id]]" container-width="100%"></vimeo-video>
										</template>

									</can-form>

								</article>
							</div>
						</placetobe-card>

						<placetobe-card loaded="{{campaignTextCardLoaded}}" title="Campagnetekst">
							<div slot="main">
								<article>
									<p>Verleid en overtuig de crowd met je verhaal.</p>
									<article id="campaignText" on-tap="openTextEditor"></article>
								</article>
							</div>
						</placetobe-card>


						<placetobe-card title="Coverfoto">
							<div slot="main">
								<article>
									<p>Laat jezelf zien! Kies een duidelijke foto van jou of jullie, de ondernemer(s), waarbij je laat zien wat je
										doet. ({{maximumCoverFileSize}} KB)</p>

									<ul>
										<li>De foto moet liggend en van goede kwaliteit zijn</li>
										<li>Het moet één foto zijn, geen samengevoegde foto’s</li>
										<li>Plak geen teksten of banners op de foto en maak geen gebruik van onnatuurlijke bewerkingen</li>
										<li>Houd de foto bij voorkeur in kleur</li>
									</ul>

									<can-campaign-cover-form disabled$="[[!editable]]" disabled-warning="[[notEditableWarning]]" campaign-id="{{campaign.id}}"
									 valid="{{coverCompleted}}" maximum-file-size="{{maximumCoverFileSize}}"></can-campaign-cover-form>

									<p>Houd er rekening mee dat wanneer de foto niet aan de eisen voldoet, we jou kunnen vragen een andere foto
										uit te kiezen.</p>

								</article>
							</div>
						</placetobe-card>

						<placetobe-card title="Extra documenten uploaden">
							<div slot="main">
								<article>

									<can-api auth active-role="entrepreneur" auto="[[campaignId]]" api-endpoint="[[apiEndpoint]]" route="campaigns/[[campaignId]]/publicfiles"
									 method="GET" last-response="{{publicFiles}}" access-token="{{accessToken}}"></can-api>

									<p>Wil je extra documenten aanbieden aan je investeerders, bijvoorbeeld je bedrijfsplan? Upload dan hier de
										bestanden (max. 5 MB per bestand).</p>
									<!-- 
                  <ul>
                  <li>Upload je bestand door te klikken op 'Upload bestand'.</li>
                  <li>Klik op de bestandsnaam, hij opent in een nieuw venster.</li>
                  <li>Kopieer de URL die in de balk bovenaan verschijnt.</li>
                  <li>Voer deze in als hyperlink aan je campagnetekst.</li>
                  </ul> -->

									<can-file-io disabled$="[[disabled]]" disabled-warning="[[disabledWarning]]" api-route="entrepreneurs/[[userId]]/publicfiles"
									 user-id="[[campaignId]]" download-data="{{publicFiles}}" on-upload-failed="_uploadFailed" select-button-label="upload bestand"
									 maximum-file-size="{{maximumFileSize}}" method="POST"></can-file-io>

								</article>
							</div>

						</placetobe-card>

						<template is="dom-repeat" items="[[publicFiles.files]]">
							<placetobe-card title="[[item.fileName]]">
								<article slot="main">
									<can-api auth active-role="entrepreneur" access-token="{{accessToken}}" api-endpoint="[[apiEndpoint]]" route="entrepreneurs/[[userId]]/publicfiles/[[item.fileNameEncoded]]"
									 method="DELETE" last-response="{{publicFiles}}" id="publicFile[[index]]"></can-api>

									<placetobe-input-box name="Betstand URL" value="[[item.url]]" disabled></placetobe-input-box>

									<placetobe-button href$="[[item.url]]" title$="[[item.fileName]]" target="_blank" link>Open bestand</placetobe-button>
									|
									<placetobe-button on-tap="_deletePublicFile" link>verwijder</placetobe-button>

								</article>

							</placetobe-card>
						</template>

					</template>

					<template is="dom-if" if="[[_selectedTabEquals(selectedTab, 'finance')]]">

						<article>
							<p>Bouw het fundament van je campagne. Hoeveel heb je nodig? Hoe lang wil je erover doen?</p>
						</article>

						<placetobe-card title="Doelbedragen">
							<div slot="main">
								<article>

									<p>Hoeveel wil je minimaal én maximaal crowdfunden met je campagne?</p>

									<can-form auth active-role="entrepreneur" access-token="{{accessToken}}" api-endpoint="[[apiEndpoint]]"
									 disabled$="[[!editable]]" disabled-warning="[[notEditableWarning]]" apipath="entrepreneurs/[[campaign.id]]/requiredandmaxfunding"
									 id="requiredandmaxfunding-form" formdata="[[campaign]]" method="PUT" valid="{{goalsCompleted}}" on-response="_updateCampaignData">

										<placetobe-input-box name="minimaal... (€)" type="number" value="{{campaign.requiredFunding}}" placeholder="minimaal... (€)"
										 min="5" pattern="([0-9])+" required></placetobe-input-box>

										<placetobe-input-box name="...en maximaal (€)" type="number" value="{{campaign.maxFunding}}" placeholder="...en maximaal (€)"
										 pattern="([0-9])+" tip="Denk goed na over je maximale bedrag. Je moet een duidelijk plan hebben voor het geld dat je extra ophaalt. Let op: bij een leningcampagne kan het maximale bedrag niet hoger zijn dan tweemaal het minimumbedrag."
										 min="{{campaign.requiredFunding}}" max="{{maxRequiredFunding}}" required></placetobe-input-box>

									</can-form>

								</article>
							</div>

						</placetobe-card>

						<placetobe-card title="Campagnedata" id="dates">
							<div slot="main">
								<article>
									<p>Op basis van onderstaande gegevens geven we je informatie over je aflossingsdata en -bedragen</p>

									<can-form auth active-role="entrepreneur" access-token="{{accessToken}}" api-endpoint="[[apiEndpoint]]"
									 disabled$="[[!editable]]" disabled-warning="[[notEditableWarning]]" formdata="{{campaign}}" apipath="entrepreneurs/[[campaign.id]]/datesinterest"
									 id="dates-interest-form" method="PUT" valid="{{datesCompleted}}" on-response="_updateCampaignData">

										<placetobe-input-box type="date" date-format="YYYY-MM-DD" min="[[today]]" max="2099-12-31" value="{{campaign.endDate}}"
										 placeholder="einddatum van je campagne" required></placetobe-input-box>

										<template is="dom-if" if="[[isLening]]">

											<template is="dom-if" if="[[!isYearlyLoan]]">

												<placetobe-select-box name="Hoe wil je aflossen?" value="{{campaign.annuity}}" options="[[annuityItems]]"
												 required></placetobe-select-box>
											</template>

											<template is="dom-if" if="[[paysInTerms]]">
												<placetobe-input-box name="wanneer begin je met aflossen?" type="date" date-format="YYYY-MM-DD" min="[[campaign.endDate]]"
												 max="[[campaign.finalPaymentDate]]" value="{{campaign.firstPaymentDate}}" placeholder="wanneer begin je met aflossen?"
												 required="[[paysInTerms]]"></placetobe-input-box>
											</template>

											<placetobe-input-box name="wanneer eindig je met aflossen?" type="date" date-format="YYYY-MM-DD" min="[[campaign.firstPaymentDate]]"
											 max="2099-12-31" value="{{campaign.finalPaymentDate}}" placeholder="wanneer eindig je met aflossen?"
											 required></placetobe-input-box>

											<placetobe-input-box name="[[totalInterestLabel]]" value="{{campaign.returnOnInvestmentPercentage}}"
											 placeholder$="[[totalInterestLabel]]" step="0.1" pattern="^\d{1,3}(?:\.\d)?$" required></placetobe-input-box>

										</template>

									</can-form>

								</article>
							</div>
						</placetobe-card>

						<template is="dom-if" if="[[isLening]]">
							<can-campaign-repayments-card campaign-id="[[campaign.id]]" amounts="[[repaymentAmounts]]"></can-campaign-repayments-card>
							<br>
						</template>

						<placetobe-card title="Investeersdersbedragen">
							<div slot="main">
								<article>
									<p>Wat zijn de minimale én maximale bedragen die een persoon per keer kan investeren?</p>

									<caas-campaign-types auto-download="[[campaign.id]]" campaign-types="{{campaignTypes}}" api-endpoint="[[apiEndpoint]]"
									 campaign-id="[[campaign.id]]" access-token="[[accessToken]]" response-status="{{campaignTypesResponseStatus}}">
									</caas-campaign-types>

									<can-form use-with-caas access-token="{{accessToken}}" api-endpoint="[[apiEndpoint]]" disabled$="[[!editable]]"
									 disabled-warning="[[notEditableWarning]]" id="requiredFunding-form" valid="{{investAmountsCompleted}}"
									 response-status="[[campaignTypesResponseStatus]]" on-caas-submit="_saveCampaignTypes">

										<template is="dom-repeat" items="{{campaignTypes}}" index-as="index">

											<placetobe-input-box name="minimaal... [[item.contractTypeName]] (€)" type="number" value="{{item.minimumInvestment::change}}"
											 placeholder="minimaal... [[item.contractTypeName]] (€)" min="5" max="80000" pattern="([0-9])+">
											</placetobe-input-box>

											<placetobe-input-box name="Het minimale bedrag is €5, het maximale €80000." type="number" value="{{item.maximumInvestment::change}}"
											 placeholder="... en maximaal [[item.contractTypeName]] (€)" description="Het minimale bedrag is €5, het maximale €80000."
											 min="[[item.minimumInvestment]]" max="80000" pattern="([0-9])+">
											</placetobe-input-box>

											<template is="dom-if" if="[[isAandelen]]">
												<placetobe-input-box name="Dit is de waarde van 1 aandeel" type="number" value="{{item.investmentIncrement::change}}"
												 placeholder="Emissiewaarde (€)" pattern="([0-9])+" description="Dit is de waarde van 1 aandeel" min="{{item.minimumInvestment}}"
												 max="{{item.maximumInvestment}}" required>
												</placetobe-input-box>
											</template>

										</template>

									</can-form>

								</article>
							</div>
						</placetobe-card>

						<template is="dom-if" if="[[isAandelen]]">

							<can-card>
								<header>
									<h3>Aandelen</h3>
									<p>Vul hier de emissie waarde van 1 aandeel in.</p>
									<p>Het aantal te verstrekken aandelen is: doelbedrag / waarde 1 aandeel.</p>
								</header>
								<article>

									<can-form auth active-role="entrepreneur" access-token="{{accessToken}}" api-endpoint="[[apiEndpoint]]"
									 disabled$="[[!editable]]" disabled-warning="[[notEditableWarning]]" apipath="entrepreneurs/[[campaign.id]]/certificatepassingdate"
									 id="certificatepassingdate-form" formdata="[[campaign]]" method="PUT" valid="{{certificatePassingDateCompleted}}"
									 on-response="_updateCampaignData">

										<can-textinput name="certificatePassingDate" type="date" date-format="YYYY-MM-DD" min="2016-01-01" max="2099-12-31"
										 value="{{campaign.certificatePassingDate}}" description="De dag van de waarheid" placeholder="Passeerdatum van de certificaten?"></can-textinput>

									</can-form>

								</article>

							</can-card>
						</template>


					</template>

					<template is="dom-if" if="[[_selectedTabEquals(selectedTab, 'details')]]">

						<article>
							<p>Vul hier de gegevens van jouw onderneming in.</p>
						</article>

						<placetobe-card title="Jouw onderneming">
							<div slot="main">
								<article>
									<p>
										<can-user-profile-form user-id="[[userId]]" role="ondernemer" disabled$="[[!editable]]" disabled-warning="[[notEditableWarning]]"
										 is-stocks-campaign="[[isAandelen]]"></can-user-profile-form>
									</p>
								</article>
							</div>
						</placetobe-card>

						<placetobe-card title="Kopie ID">
							<div slot="main">
								<article>
									<p>Upload hier een digitale kopie van je paspoort, identiteitskaart of rijbewijs (maximum
										[[maximumIDFileSize]] KB)</p>
									<can-campaign-id-form disabled$="[[!editable]]" disabled-warning="[[notEditableWarning]]" campaign-id="[[campaign.id]]"
									 valid="{{campaignIdComplete}}" maximum-file-size="{{maximumIDFileSize}}"></can-campaign-id-form>
								</article>
							</div>
						</placetobe-card>

						<placetobe-card title="KVK uittreksel">
							<div slot="main">
								<article>
									<p>Upload hier een digitaal KVK uittreksel (maximum [[maximumKvkFileSize]] KB)</p>
									<can-campaign-kvk-form disabled$="[[!editable]]" disabled-warning="[[notEditableWarning]]" campaign-id="[[campaign.id]]"
									 valid="{{campaignKvkComplete}}" maximum-file-size="{{maximumKvkFileSize}}"></can-campaign-kvk-form>
								</article>
							</div>
						</placetobe-card>

						<placetobe-card title="Overeenkomst">
							<div slot="main">
								<article>
									<ul>
										<li>
											<template is="dom-if" if="[[isLening]]">
												<a href="https://assets.crowdaboutnow.nl/pdf/leningovereenkomst_CAN_ondernemer_V3.pdf" target="_blank">Stap
													1: Download de overeenkomst
												</a>
											</template>
											<template is="dom-if" if="[[!isLening]]">
												<a href="https://assets.crowdaboutnow.nl/pdf/voorverkoopoverkeenkomst_CAN_ondernemer_V3.pdf" target="_blank">Stap
													1: Download de overeenkomst</a>
											</template>
										</li>
										<li>Stap 2: Print, vul in en onderteken</li>
										<li>Stap 3: Scan de overeenkomst (duidelijk leesbaar!)</li>
										<li>Stap 4: Upload je getekende overeenkomst (als jpg, maximum [[maximumContractFileSize]] KB)</li>
									</ul>
									<can-campaign-contract-form disabled$="[[!editable]]" disabled-warning="[[notEditableWarning]]" campaign-id="[[campaign.id]]"
									 valid="{{campaignContractComplete}}" maximum-file-size="{{maximumContractFileSize}}"></can-campaign-contract-form>
								</article>
							</div>
						</placetobe-card>

					</template>

					<template is="dom-if" if="[[_selectedTabEquals(selectedTab, 'incentives')]]">

						<article>
							<p>Hoe ga je je supporters bedanken?</p>
						</article>

						<can-campaign-incentives-form api-endpoint="[[apiEndpoint]]" access-token="{{accessToken}}" campaign-started="[[campaign.started]]"
						 disabled$="[[!editable]]" disabled-warning="[[notEditableWarning]]" campaignid="[[campaign.id]]"
						 contract-type-ids="[[campaign.contractTypeIds]]" campaign-minimum="[[campaign.minInvestment]]" campaign-maximum="[[campaign.maxInvestment]]"
						 valid="{{incentivesComplete}}"></can-campaign-incentives-form>

					</template>

					<template is="dom-if" if="[[_selectedTabEquals(selectedTab, 'investments')]]">

						<article>
							<p>Hier zie je alle investeerders en hoe je met ze in contact komt. Lukt het niet om een contract te downloaden?
								Check of de pop-up blocker van je browser uit staat.</p>
						</article>

						<placetobe-card title="Overzicht investeerders">
							<article slot="main">Klik hieronder om een overzicht te downloaden van je investeerders.</article>

							<div slot="footer">
								<can-api download-file auth active-role="entrepreneur" access-token="{{accessToken}}" api-endpoint="[[apiEndpoint]]"
								 content-type="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" id="export-excel"
								 downloaded-filename="contracts.xlsx" route="entrepreneurs/[[userId]]/contracts/export/excel" on-response="_excelDownloadSuccess"
								 method="GET" loading="{{loadingExcel}}">
								</can-api>

								<placetobe-button on-tap="_getExportExcel" waiting="[[loadingExcel]]">Download Excel bestand</placetobe-button>

							</div>
						</placetobe-card>

						<can-contracts-table campaign-id="[[campaign.id]]"></can-contracts-table>

					</template>

					<template is="dom-if" if="[[_selectedTabEquals(selectedTab, 'preview')]]" restamp="true">
						<placetobe-campaign-page api-endpoint="[[apiEndpoint]]" campaign-slug="[[campaign.slug]]" campaign-id="[[campaign.id]]" access-token="[[accessToken]]"></placetobe-campaign-page>
					</template>

				</div>

				<aside hidden$="[[_selectedTabEquals(selectedTab, 'preview')]]">
					<placetobe-campaign-stats-card api-endpoint="[[apiEndpoint]]" campaign-id="[[campaign.id]]" access-token="[[accessToken]]" vertical></placetobe-campaign-stats-card>

					<br>

					<placetobe-card title="Campagne Status">
						<div slot="main">
							<article>
								<h4 hidden$="[[!campaign.started]]">Campagne loopt!</h4>
								<h4 hidden$="[[campaign.started]]">[[campaignStatusLabel]]</h4>
							</article>
						</div>
					</placetobe-card>

					<placetobe-card title="Formaliteiten">

						<can-api 
							auth
							active-role="entrepreneur" 
							
							access-token="{{accessToken}}" 
							api-endpoint="[[apiEndpoint]]" 
							auto="[[campaignId]]"
							route="entrepreneurs/[[campaignId]]/administrativeformalities"
							method="GET" 
							last-response="{{administrativeFormalities}}"
						></can-api>

						<div slot="main">
							<article class="administrativeFormalities">

								<p>Onze financiële administratie houdt bij waaraan voldaan is.</p>
								<ul>
									<li data-completed$="[[administrativeFormalities.contractDocumentReceived]]" data-uncomplete$="[[!administrativeFormalities.contractDocumentReceived]]">contract
										goedgekeurd</li>
									<li data-completed$="[[administrativeFormalities.identificationDocumentReceived]]" data-uncomplete$="[[!administrativeFormalities.identificationDocumentReceived]]">ID
										goedgekeurd</li>
									<li data-completed$="[[administrativeFormalities.KVKDocumentReceived]]" data-uncomplete$="[[!administrativeFormalities.KVKDocumentReceived]]">KvK
										uittreksel ontvangen</li>
									<li data-completed$="[[administrativeFormalities.paymentReceived]]" data-uncomplete$="[[!administrativeFormalities.paymentReceived]]">factuur
										betaald</li>
									<li data-completed$="[[administrativeFormalities.basicCampaignInformationApproved]]" data-uncomplete$="[[!administrativeFormalities.basicCampaignInformationApproved]]">basisgegevens
										goedgekeurd</li>
								</ul>
							</article>
						</div>
					</placetobe-card>

					<can-campaign-location-card address="[[campaign.address]]" geocode="[[campaign.geocode]]">
						<p>
							<placetobe-button on-tap="openLocationSelector">Wijzig</placetobe-button>
					</can-campaign-location-card>

				</aside>


			</main>


			<!-- <can-card>
                        <header>
                            <h3>Social media</h3>
                            <p>Bouw een band met je achterban door ze iets meer van jezelf te laten zien. </p>
                        </header>
                        <article>
                            <can-form
                                auth
                                access-token="{{accessToken}}"
                                api-endpoint="[[apiEndpoint]]"
                                disabled$="[[!editable]]"
                                disabled-warning="[[notEditableWarning]]"
                                apipath="entrepreneurs/[[campaign.id]]/sociallinks"
                                formdata="[[campaign]]"
                                id="sociallinks-form"
                                method="PUT"
                                valid="{{socialCompleted}}"
                                >
                                <can-textinput
                                    name="facebook"
                                    value="{{campaign.facebook}}"
                                    placeholder="Facebook URL"
                                    description="Zorg ervoor dat je Facebook URL altijd begint met https://facebook.com/"
                                >
                                </can-textinput>
                                <can-textinput
                                    name="twitter"
                                    value="{{campaign.twitter}}"
                                    placeholder="Twitter URL"
                                    description="Zorg ervoor dat je Twitter URL altijd begint met https://twitter.com/"
                                >
                                </can-textinput>
                                <can-textinput
                                    name="linkedin"
                                    value="{{campaign.linkedin}}"
                                    placeholder="LinkedIn URL"
                                    description="Zorg ervoor dat je LinkedIn URL altijd begint met https://linkedin.com"
                                >
                                </can-textinput>
                                <can-textinput
                                    name="instagram"
                                    value="{{campaign.instagram}}"
                                    placeholder="Instagram URL"
                                    description="Zorg ervoor dat je Instagram URL altijd begint met https://instagram.com/"
                                >
                                </can-textinput>
                            </can-form>
                        </article>
                    </can-card> -->



			<can-overlay id="location-selector-overlay" with-backdrop no-cancel-on-outside-click no-cancel-on-esc-key>

				<can-api auth active-role="entrepreneur" access-token="{{accessToken}}" api-endpoint="[[apiEndpoint]]" id="update-campaign-geocode"
				 content-type="application/json" body="{{campaign}}" route="entrepreneurs/[[campaign.id]]/geocode" method="PUT"
				 on-response="geoCodeSaved" on-error="geoCodeSavedError">
				</can-api>

				<can-location-selector geocode="{{campaign.geocode}}"></can-location-selector>


				<placetobe-button on-tap="saveGeocode">Opslaan</placetobe-button>
				<placetobe-button link on-tap="requestCloseLocationSelector">annuleren</placetobe-button>
			</can-overlay>

			<can-overlay id="campaign-text-overlay" with-backdrop no-cancel-on-outside-click no-cancel-on-esc-key>

				<can-loader hidden$="[[!savingInterviewText]]"></can-loader>

				<can-api auth active-role="entrepreneur" access-token="{{accessToken}}" api-endpoint="[[apiEndpoint]]" id="update-campaign-text"
				 content-type="application/json" body='{"interview": "[[htmlInterview]]"}' route="entrepreneurs/[[campaign.id]]/campaigntext"
				 on-request="saveInterviewText" on-response="interviewTextSaved" on-error="interviewTextSavedError" method="PUT">
				</can-api>

				<silk-editor disabled="[[savingInterviewText]]" resize-images paste-plain-text fixed-formatting-bar
				 max-image-height="800" max-image-width="800" max-image-size="1000" content="[[campaign.interview]]"
				 on-content-change="_handleCampaignText" formatting-options="bold,italics,h3,unorderedlist,orderedlist,link,image,underline,vimeo,youtube"></silk-editor>
				<placetobe-button on-tap="saveCampaignText">Opslaan</placetobe-button>
				<placetobe-button link on-tap="requestCloseTextEditor">annuleren</placetobe-button>
			</can-overlay>

		</template>

	</template>

	<script>
		Polymer({

			is: 'placetobe-campaign-dashboard',
			behaviors: [CaasAuthBehavior],

			properties: {
				apiEndpoint: {
					type: String,
					value: null
				},

				userId: {
					type: String
				},

				signedIn: {
					type: Boolean,
					value: false
				},
				accessToken: {
					type: String,
					value: window.localStorage.getItem('CanSessionToken')
				},
				campaign: {
					type: Object,
					notify: true
				},
				activeContractId: {
					type: String,
					notify: true,
					computed: '_getActiveContractId(campaign.contractTypeIds)'
				},
				basicsCompleted: {
					type: Boolean,
					value: false
				},
				categoriesCompleted: {
					type: Boolean,
					value: false
				},
				videoCompleted: {
					type: Boolean,
					value: false
				},
				coverCompleted: {
					type: Boolean,
					value: false
				},
				socialCompleted: {
					type: Boolean,
					value: false
				},
				tabOneCompleted: {
					type: Boolean,
					computed: '_tabOneIsComplete(basicsCompleted, categoriesCompleted, videoCompleted, coverCompleted, socialCompleted)'
				},
				goalsCompleted: {
					type: Boolean,
					value: false
				},
				datesCompleted: {
					type: Boolean,
					value: false
				},
				investAmountsCompleted: {
					type: Boolean,
					value: false
				},
				tabTwoComplete: {
					type: Boolean,
					computed: '_tabTwoIsComplete(goalsCompleted, datesCompleted, investAmountsCompleted)'
				},
				campaignIdComplete: {
					type: Boolean,
					value: false
				},
				campaignContractComplete: {
					type: Boolean,
					value: false
				},
				campaignKvkComplete: {
					type: Boolean,
					value: false
				},
				tabThreeComplete: {
					type: Boolean,
					computed: '_tabThreeIsComplete(campaignIdComplete, campaignContractComplete, campaignKvkComplete)'
				},
				incentivesComplete: {
					type: Boolean
				},
				tabFourComplete: {
					type: Boolean,
					computed: '_tabFourIsComplete(incentivesComplete)'
				},
				percentageCompleted: {
					type: Number,
					computed: '_computePercentageCompleted(basicsCompleted, categoriesCompleted, videoCompleted, coverCompleted, socialCompleted, goalsCompleted, datesCompleted, investAmountsCompleted, campaignIdComplete, campaignKvkComplete, campaignContractComplete, incentivesComplete, administrativeFormalities.contractDocumentReceived, administrativeFormalities.identificationDocumentReceived, administrativeFormalities.KVKDocumentReceived, administrativeFormalities.paymentReceived, administrativeFormalities.basicCampaignInformationApproved)'
				},
				userId: {
					type: String,
					value: null
				},
				isLening: {
					type: Boolean,
					notify: true,
					computed: '_computeIsLening(campaign.contractTypeIds)'
				},
				isAandelen: {
					type: Boolean,
					notify: true,
					computed: '_computeIsAandelen(campaign.contractTypeIds)'
				},
				paysInTerms: {
					type: Boolean,
					notify: true,
					computed: '_computePayInTerms(campaign.annuity)'
				},
				annuityItems: {
					type: Object,
					notify: true,
					value: [
						{ label: 'In 1 keer', value: 0 },
						{ label: '3 maandelijks', value: 3 },
						{ label: 'Half jaarlijks', value: 6 },
						{ label: 'Jaarlijks', value: 12 }
					]
				},
				maxRequiredFunding: {
					type: Number,
					computed: '_getMaxRequiredFunding(campaign.requiredFunding, isLening)'
				},

				today: {
					type: String,
					value: function () {
						return moment().format('YYYY-MM-DD');
					}
				},
				campaignStatusLabel: {
					type: String,
					computed: '_getCampaignStatusLabel(campaign.status)'
				},

				selectedTab: {
					type: String,
					value: 'story'
				},

				editable: {
					type: Boolean,
					computed: '_computeIfIsEditable(campaign.entrepreneurCanEdit, campaign.started, userRole)',
					value: false
				},

				notEditableWarning: {
					type: String,
					computed: '_computeNotEditableWarning(campaign.entrepreneurCanEdit, campaign.started)'
				},
				htmlInterview: {
					type: String,
					value: null
				},

				loggedIn: {
					type: Boolean,
					notify: true,
					value: false
				},
				userRole: {
					type: String,
					value: null
				},
				editorEnabled: {
					type: Boolean,
					value: false,
					computed: '_computeEditorIsEnabled(userRole)'
				},
				savingInterviewText: {
					type: Boolean,
					value: false
				},
				administrativeFormalities: {
					type: Object,
					value: {}
				},

				repaymentAmounts: {
					type: Array,
					computed: '_getRepaymentAmounts(campaign.requiredFunding, campaign.maxFunding)'
				},
				loadingExcel: {
					type: Boolean,
					value: false
				},
				tabsdata: Array,
				maximumFileSize: Number,
				maximumCoverFileSize: Number,
				maximumIDFileSize: Number,
				maximumContractFileSize: Number,
				maximumKvkFileSize: Number,
				disabled: Boolean,
				disabledWarning: String,
				campaignId: {
					type: Number,
					value: null,
					notify: true,
					computed: 'getCampaignId(campaignAdministrators)'
				},
				
				
				totalInterestLabel: {
					type: String,
					computed: '_computeTotalInterestLabel(activeContractId)'
				},
				isYearlyLoan: {
					type: Boolean,
					computed: '_computeIfLoanIsOnlyYearly(campaign.contractTypeIds, isLening)'
				},
				campaignAdministrators: {
					type: Array,
					value: null,
					notify: true
				}
				
			},
			observers: [
				'_parseFacebookURL(campaign.facebook)',
				'_parseTwitterURL(campaign.twitter)',
				'_parseLinkedInURL(campaign.linkedin)',
				'_setCampaignText(campaign.interview, campaignTextCardLoaded)',
				'_setVideo(campaign.video.url)',
				'_setUserParameters(_tokenData.data.*)'
			],

			_setUserParameters: function (tokenDataChange) {
				this.userId = this._tokenData.data.userId;
			},
			ready: function () {
				window.scrollTo(0, 0);
				this.addEventListener('image-upload-error', function (e) {
					alert(e.detail);
				});
			},

			getCampaignId: function(campaignAdministrators) {
				if (!campaignAdministrators) return null;
				return campaignAdministrators[0].campaignId;
			},
			_computeIsLening: function (contractTypeIds) {
				if (!contractTypeIds) return;
				return (contractTypeIds.indexOf(3) != -1 || contractTypeIds.indexOf(4) != -1 || contractTypeIds.indexOf(7) != -1 || contractTypeIds.indexOf(8) != -1);
			},

			_computeIsAandelen: function (contractTypeIds) {
				if (!contractTypeIds) return;
				return (contractTypeIds.indexOf(5) != -1 || contractTypeIds.indexOf(6) != -1);
			},

			_computeIfLoanIsOnlyYearly: function (contractTypeIds, isLening) {
				if (!contractTypeIds) return;
				if (!isLening) return false;
				return (contractTypeIds.indexOf(7) != -1 || contractTypeIds.indexOf(8) != -1);
			},

			_computePayInTerms: function (annuity) {
				return (annuity != 0);
			},

			_getActiveContractId: function (contractTypeIds) {
				return (contractTypeIds) ? contractTypeIds[0] : null;
			},

			handleBasicsError: function () {
			},

			_tabOneIsComplete: function (basicsCompleted, categoriesCompleted, videoCompleted, coverCompleted, socialCompleted) {
				return (basicsCompleted && categoriesCompleted && videoCompleted && coverCompleted && socialCompleted);
			},

			_tabTwoIsComplete: function (goalsCompleted, datesCompleted, investAmountsCompleted) {
				return (goalsCompleted && datesCompleted && investAmountsCompleted);
			},

			_tabThreeIsComplete: function (campaignIdComplete, campaignContractComplete, campaignKvkComplete) {
				return (campaignIdComplete, campaignContractComplete, campaignKvkComplete);
			},

			_tabFourIsComplete: function (incentivesComplete) {
				return ((!!incentivesComplete));
			},

			_computePercentageCompleted: function (basicsCompleted, categoriesCompleted, videoCompleted, coverCompleted, socialCompleted, goalsCompleted, datesCompleted, investAmountsCompleted, campaignIdComplete, campaignKvkComplete, campaignContractComplete, incentivesComplete, contractDocumentReceived, identificationDocumentReceived, KVKDocumentReceived, paymentReceived, basicCampaignInformationApproved) {
				var numberOfCompletes = 0;
				var completables = [basicsCompleted, categoriesCompleted, videoCompleted, coverCompleted, socialCompleted, goalsCompleted, datesCompleted, investAmountsCompleted, campaignIdComplete, campaignKvkComplete, campaignContractComplete, incentivesComplete, contractDocumentReceived, identificationDocumentReceived, KVKDocumentReceived, paymentReceived, basicCampaignInformationApproved];

				for (var i = 0; i < completables.length; i++) {
					if (completables[i]) numberOfCompletes++;
				}
				return (numberOfCompletes * 100) / completables.length;
			},

			_parseFacebookURL: function (facebookURL) {
				if (!facebookURL) return;
				this.set('campaign.facebook', this._parseSocialURL(facebookURL));
			},

			_parseTwitterURL: function (twitterURL) {
				if (!twitterURL) return;
				this.set('campaign.twitter', this._parseSocialURL(twitterURL));
			},

			_parseLinkedInURL: function (linkedInURL) {
				if (!linkedInURL) return;
				this.set('campaign.linkedin', this._parseSocialURL(linkedInURL));
			},

			_parseSocialURL: function (socialURL) {
				return socialURL.replace(/\?.*?$/, '');
			},

			_getMaxRequiredFunding: function (requiredFunding, isLening) {
				return (isLening) ? (requiredFunding * 2) : '';
			},

			_getCampaignStatusLabel: function (campaignStatus) {
				switch (campaignStatus) {
					case 0:
						return 'in voorbereiding';
					case 1:
						return 'lopend';
					case 2:
					case 3:
					case 4:
						return 'succesvol';
					default:
						return 'afgerond';
				}
			},
			_handleCampaignText: function (e, interviewText) {
				this.set('htmlInterview', interviewText.replace(/"/g, '\\"'));
			},

			saveCampaignText: function () {
				this.$$('#update-campaign-text').send();
			},

			openTextEditor: function () {
				this.set('htmlInterview', this.campaign.interview.replace(/"/g, '\\"'));
				this.$$('can-overlay#campaign-text-overlay').open();
			},

			requestCloseTextEditor: function () {
				var close = window.confirm('Weet je zeker dat je de editor wilt verlaten? Eventuele wijzigingen gaan mogelijk verloren.');
				if (close) {
					this.closeTextEditor();
				}
			},

			closeTextEditor: function () {
				this.$$('can-overlay#campaign-text-overlay').close();
			},

			saveGeocode: function () {
				this.$$('#update-campaign-geocode').send();
			},

			openLocationSelector: function () {
				//this.set('htmlInterview', this.campaign.interview.replace(/"/g, '\\"'));
				this.$$('can-overlay#location-selector-overlay').open();
			},

			requestCloseLocationSelector: function () {
				var close = window.confirm('Weet je zeker dat je de locatie selectie wilt verlaten? Eventuele wijzigingen gaan mogelijk verloren.');
				if (close) {
					this.closeLocationSelector();
				}
			},

			closeLocationSelector: function () {
				this.$$('can-overlay#location-selector-overlay').close();
			},

			geoCodeSaved: function () {
				this.closeLocationSelector();
			},

			geoCodeSavedError: function () {
				alert('Sorry, er is iets misgegaan tijdens het bewaren van de locatie. Probeer het opnieuw a.u.b.');
			},

			_computeNotEditableWarning: function (entrepreneurCanEdit, campaignStarted) {
				if (campaignStarted) return 'Je kunt deze informatie niet wijzigen omdat je campagne is gestart.';
				if (!entrepreneurCanEdit) return 'Je kunt deze informatie (nog) niet wijzigen.';
				return 'Deze campagne is gesloten';
			},

			_computeIfIsEditable: function (entrepreneurCanEdit, started, userRole) {
				if (userRole == 'accountmanager') return true;
				if (userRole == 'financialadministrator') return true;
				if (started) return false;
				if (entrepreneurCanEdit) return true;
				return false;
			},

			_computeEditorIsEnabled: function (userRole) {
				if (userRole == 'accountmanager') return true;
				if (userRole == 'financialadministrator') return true;
				return false;
			},

			_getExportExcel: function () {
				this.set('loadingExcel', true);
				this.$$('#export-excel').send();
			},

			_excelDownloadSuccess: function () {
				this.set('loadingExcel', false);
			},

			_setCampaignText: function (campaignInterview) {
				this.$$('#campaignText').innerHTML = campaignInterview;
			},
			saveInterviewText: function () {
				this.savingInterviewText = true;
			},
			interviewTextSaved: function () {
				this.savingInterviewText = false;
				this.set('campaign.interview', this.htmlInterview.replace(/\\"/g, '"'));
				this.closeTextEditor();
			},
			interviewTextSavedError: function () {
				alert('Sorry, er is iets misgegaan tijdens het bewaren van de tekst. Probeer het opnieuw a.u.b.');
				this.savingInterviewText = false;
			},

			_setVideo: function (campaignVideoURL) {
				if (!campaignVideoURL) return;
				var pattern = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/g;
				var youtubeID = campaignVideoURL.replace(pattern, '$7');

				if (campaignVideoURL.match(pattern)) {

					this.set('campaign.video.vimeo', {});
					this.notifyPath('campaign.video.vimeo', {});

					this.set('campaign.video.youtube', { id: youtubeID });
					this.notifyPath('campaign.video.youtube', { id: youtubeID });

					return;
				}

				pattern = /^.*?\/([0-9]{3,12})$/;
				var vimeoID = campaignVideoURL.replace(pattern, '$1');

				if (campaignVideoURL.match(pattern)) {

					this.set('campaign.video.youtube', {});
					this.notifyPath('campaign.video.youtube', {});

					this.set('campaign.video.vimeo', { id: vimeoID });
					this.notifyPath('campaign.video.vimeo', { id: vimeoID });

				}

			},

			_updateCampaignData: function () {
				this.$$('can-campaign-stats-card').updateStatsData();
				this.$$('caas-campaign-types').getItems();
				if (this.isLening) this.$$('can-campaign-repayments-card').updatePaymentData();
			},

			_getRepaymentAmounts: function (requiredFunding, maxFunding) {
				return [Number(maxFunding), Number(requiredFunding)];
			},

			_deletePublicFile: function (evt) {
				if (confirm('Weet je zeker dat je ' + evt.model.item.fileName + ' wilt verwijderen?')) {
					this.$$('#publicFile' + evt.model.index).send();
				} else {
					return;
				}
			},

			_computeTotalInterestLabel: function (activeContractId) {
				if (activeContractId == 7 || activeContractId == 8) return 'jaarrendement (%)';
				return 'rendement over de gehele periode (%)';
			},

			updateCampaignData: function () {
				this.$$('#campaignAjax').send();
			},

			_saveCampaignTypes: function () {
				var campaignTypes = this.campaignTypes;
				for (var i = 0; i < campaignTypes.length; i++) {
					this.$$('caas-campaign-types').notifyPath('campaignTypes.' + [i] + '.id');
				}
			},

			_selectedTabEquals: function (selectedTab, value) {
				return selectedTab === value;
			},

			signOut: function () {
				this.$.signInCard.signOut();
			},

		});
	</script>
</dom-module>