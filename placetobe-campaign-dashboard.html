<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../placetobe-styles/placetobe-styles.html">
<link rel="import" href="../caas-auth-behavior/caas-auth-behavior.html">
<link rel="import" href="../placetobe-signin-card/placetobe-signin-card.html">
<link rel="import" href="../placetobe-card/placetobe-card.html">
<link rel="import" href="../placetobe-input-box/placetobe-input-box.html">
<link rel="import" href="../placetobe-button/placetobe-button.html">


<link rel="import" href="can-api/can-api.html">


<script src="../moment/moment.js"></script>
<link rel="import" href="../google-youtube/google-youtube.html">
<link rel="import" href="../vimeo-video/vimeo-video.html">
<link rel="import" href="../silk-editor/silk-editor.html">
<link rel="import" href="../caas-campaign-types/caas-campaign-types.html">

<link rel="import" href="can-page/can-page.html">
<link rel="import" href="can-page-tabs/can-page-tabs.html">
<link rel="import" href="can-campaign-stats-card/can-campaign-stats-card.html">
<link rel="import" href="can-user-session/can-user-session.html">
<link rel="import" href="can-login-page/can-login-page.html">
<link rel="import" href="can-form/can-form.html">
<link rel="import" href="can-textinput/can-textinput.html">
<link rel="import" href="can-textarea/can-textarea.html">
<link rel="import" href="can-campaign-categories-list/can-campaign-categories-list.html">
<link rel="import" href="can-campaign-cover-form/can-campaign-cover-form.html">
<link rel="import" href="can-user-profile-form/can-user-profile-form.html">
<link rel="import" href="can-campaign-id-form/can-campaign-id-form.html">
<link rel="import" href="can-campaign-kvk-form/can-campaign-kvk-form.html">
<link rel="import" href="can-campaign-contract-form/can-campaign-contract-form.html">
<link rel="import" href="can-campaign-incentives-form/can-campaign-incentives-form.html">
<link rel="import" href="can-contracts-table/can-contracts-table.html">
<link rel="import" href="can-overlay/can-overlay.html">
<link rel="import" href="can-loader/can-loader.html">
<link rel="import" href="can-switch-button/can-switch-button.html">
<link rel="import" href="can-campaign-repayments-card/can-campaign-repayments-card.html">
<link rel="import" href="can-file-io/can-file-io.html">
<link rel="import" href="can-location-selector/can-location-selector.html">
<link rel="import" href="can-campaign-location-card/can-campaign-location-card.html">
<link rel="import" href="can-campaign-status/can-campaign-status.html">
<!--
`placetobe-campaign-dashboard`
Placetobe dashboard for campaigns

@demo demo/index.html
-->

<dom-module id="placetobe-campaign-dashboard">
  <template>
    <style>
      :host {
        display: block;
        @apply --placetobe-flex-layout--vertical;
        @apply --placetobe-cross-align--center;
      }
      placetobe-signin-card {
        width: 100%;
        max-width: 540px;
      }
      placetobe-signin-card[hidden] {
        display: none;
      }
      placetobe-card {
        width: 100%;
        max-width: 540px;
        display: flex;

        flex-direction: horizontal;
        flex-basis: wrap;
      }
      :host ul {
        list-style: none;
      }
      li {
        padding-bottom: 5px;
        display: flex;
        flex-direction: horizontal;
        flex-basis: wrap;
      }
      placetobe-input-box {
        min-width: 88px;
       --input-box-disabled-background-color: var(-placetobe-color-yellow);
      }
      placetobe-input-box:last-child {
        padding-left: 5px;
      }
    </style>

    <placetobe-signin-card
      hidden$="[[signedIn]]"
      id="signInCard"
      api-endpoint="[[apiEndpoint]]"
      signed-in="{{signedIn}}"
      access-token="{{accessToken}}"
      user-role="ondernemer"
    ></placetobe-signin-card>


    <template is="dom-if" if="[[signedIn]]" restamp="true">

        <can-api
            auth
            id="campaignAjax"
            auto="[[signedIn]]"
            route="entrepreneurs/[[userId]]"
            method="GET"
            last-response="{{campaign}}"
            access-token="{{accessToken}}"
            api-endpoint="[[apiEndpoint]]"
            >
        </can-api>


                    <can-campaign-status
                        slug="[[campaign.slug]]"
                        percentage-completed="[[percentageCompleted]]">
                    </can-campaign-status>


                    <h2>Ben je er klaar voor? Begin dan met de aankleding van je campagnepagina!</h2>

                    <can-card>
                        <header>
                            <h3>Basics</h3>
                            <p>First things first. Wat is de kern van je campagne?</p>
                        </header>
                        <article>
                            <can-form
                                auth
                                disabled$="[[!editable]]"
                                disabled-warning="[[notEditableWarning]]"
                                apipath="entrepreneurs/[[campaign.id]]/basics"
                                formdata="[[campaign]]"
                                id="basics-form"
                                on-error="handleBasicsError"
                                method="put"
                                valid="{{basicsCompleted}}"
                                >

                                <can-textinput
                                    name="projectNaam"
                                    value="{{campaign.projectNaam}}"
                                    placeholder="Projectnaam"
                                    pattern=".+"
                                    description="Hoe gaat je project heten? Dit hoeft niet gelijk te zijn aan je bedrijfsnaam. Idealiter heeft jouw campagnenaam niet meer dan 3 woorden."
                                    required
                                ></can-textinput>

                                <can-textarea
                                    name="teaser"
                                    value="{{campaign.teaser}}"
                                    placeholder="Teaser op campagneoverzicht"
                                    description="Verleid bezoekers om naar je pagina te gaan. Deze teaser komt op de overzichtenpagina te staan. (max. 140 tekens)"
                                    maxlength="140"
                                    minlength="0"
                                    required
                                ></can-textarea>

                                <can-textarea
                                    name="introductieTekst"
                                    value="{{campaign.introductieTekst}}"
                                    placeholder="Lead boven aan je pagina"
                                    description="Zeg in 400 tekens wie je bent, wat je doet en wat je met de campagne wil. Dit komt boven aan je tekst te staan."
                                    maxlength="400"
                                    minlength="0"
                                    required
                                ></can-textarea>

                            </can-form>
                        </article>

                    </can-card>

                    <can-card>
                        <header>
                            <h3>Categorieën</h3>
                            <p>Zorg dat geïnteresseerden je weten te vinden. Selecteer (maximaal 3) categorieën die betrekking hebben op je campagne</p>
                        </header>
                        <article>

                            <can-form
                                auth
                                disabled$="[[!editable]]"
                                disabled-warning="[[notEditableWarning]]"
                                formdata="[[campaign]]"
                                id="categories-form"
                                apipath="entrepreneurs/[[campaign.id]]/categories"
                                method="put"
                                valid="{{categoriesCompleted}}"
                                >

                                <can-campaign-categories-list
                                    selected-values="{{campaign.categories}}"
                                    max-select="3"
                                ></can-campaign-categories-list>

                            </can-form>

                        </article>
                    </can-card>

                    <can-card>
                        <header>
                            <h3>Video</h3>
                            <p> Trek aandacht met een video. Zo laat je zien wie je bent en wat je plan is. </p>
                        </header>
                        <article>

                            <can-form
                                auth
                                disabled$="[[!editable]]"
                                disabled-warning="[[notEditableWarning]]"
                                apipath="entrepreneurs/[[campaign.id]]/videourl"
                                formdata="[[campaign.video]]"
                                id="videourl-form"
                                method="put"
                                valid="{{videoCompleted}}"
                                >

                                <can-textinput
                                    name="videourl"
                                    value="{{campaign.video.url}}"
                                    placeholder="Vul hier de link naar je video op YouTube of Vimeo in"
                                    description="Mensen leren je kennen via video. Dus hoe persoonlijker het filmpje, hoe beter het is voor je campagne."
                                ></can-textinput>


                                <template is="dom-if" if="[[campaign.video.youtube.id]]" restamp="true">

                                    <google-youtube
                                        video-id="[[campaign.video.youtube.id]]"
                                        width="100%"
                                        height="400px"
                                        rel="0"
                                        start="0"
                                        autoplay="false"
                                        modestbranding="1"
                                        showinfo="0"
                                        iv_load_policy="3"
                                        rel="0"
                                    ></google-youtube>

                                </template>

                                <template is="dom-if" if="[[campaign.video.vimeo.id]]" restamp="true">

                                    <vimeo-video
                                        video-id="[[campaign.video.vimeo.id]]"
                                        container-width="100%"
                                    ></vimeo-video>

                                </template>

                            </can-form>

                        </article>
                    </can-card>

                    <can-card hidden$="[[!editable]]">
                        <header>
                            <h3>Campagnetekst</h3>
                            <p>Verleid en overtuig de crowd met je verhaal.</p>
                        </header>
                        <article id="campaignText" on-tap="openTextEditor"></article>
                    </can-card>

                    <can-card>

                        <header>
                            <h3>Coverfoto</h3>
                            <p>Laat jezelf zien! Kies een duidelijke foto van jou of jullie, de ondernemer(s), waarbij je laat zien wat je doet. ({{maximumCoverFileSize}} KB)</p>
                            <ul>
                                <li>De foto moet liggend en van goede kwaliteit zijn</li>
                                <li>Het moet één foto zijn, geen samengevoegde foto’s</li>
                                <li>Plak geen teksten of banners op de foto en maak geen gebruik van onnatuurlijke bewerkingen</li>
                                <li>Houd de foto bij voorkeur in kleur</li>
                            </ul>
                            <p>Houd er rekening mee dat wanneer de foto niet aan de eisen voldoet, we jou kunnen vragen een andere foto uit te kiezen.</p>
                        </header>
                        <article>
                            <can-campaign-cover-form
                                disabled$="[[!editable]]"
                                disabled-warning="[[notEditableWarning]]"
                                campaign-id="{{campaign.id}}"
                                valid="{{coverCompleted}}"
                                maximum-file-size="{{maximumCoverFileSize}}"
                            ></can-campaign-cover-form>
                        </article>
                    </can-card>

                    <can-card>
                        <header>
                            <h3>Social media</h3>
                            <p>Bouw een band met je achterban door ze iets meer van jezelf te laten zien. </p>
                        </header>
                        <article>
                            <can-form
                                auth
                                disabled$="[[!editable]]"
                                disabled-warning="[[notEditableWarning]]"
                                apipath="entrepreneurs/[[campaign.id]]/sociallinks"
                                formdata="[[campaign]]"
                                id="sociallinks-form"
                                method="PUT"
                                valid="{{socialCompleted}}"
                                >
                                <can-textinput
                                    name="facebook"
                                    value="{{campaign.facebook}}"
                                    placeholder="Facebook URL"
                                    description="Zorg ervoor dat je Facebook URL altijd begint met https://facebook.com/"
                                >
                                </can-textinput>
                                <can-textinput
                                    name="twitter"
                                    value="{{campaign.twitter}}"
                                    placeholder="Twitter URL"
                                    description="Zorg ervoor dat je Twitter URL altijd begint met https://twitter.com/"
                                >
                                </can-textinput>
                                <can-textinput
                                    name="linkedin"
                                    value="{{campaign.linkedin}}"
                                    placeholder="LinkedIn URL"
                                    description="Zorg ervoor dat je LinkedIn URL altijd begint met https://linkedin.com"
                                >
                                </can-textinput>
                                <can-textinput
                                    name="instagram"
                                    value="{{campaign.instagram}}"
                                    placeholder="Instagram URL"
                                    description="Zorg ervoor dat je Instagram URL altijd begint met https://instagram.com/"
                                >
                                </can-textinput>
                            </can-form>
                        </article>
                    </can-card>

                    <can-card>

                        <can-api
                            auth
                            auto="[[signedIn]]"
                            api-endpoint="[[apiEndpoint]]"
                            route="campaigns/[[slug]]/publicfiles"
                            method="GET"
                            last-response="{{publicFiles}}"
                            access-token="{{accessToken}}"
                            >
                        </can-api>

                        <header>
                            <h3>Extra documenten uploaden</h3>
                            <p>Wil je in je campagnetekst kunnen verwijzen naar extra documenten, bijvoorbeeld je bedrijfsplan? Upload dan hier de bestanden (max. 5 MB), zodat je de hyperlink kunt gebruiken in je campagnetekst.</p>
                            <ul>
                                <li>Upload je bestand door te klikken op 'Upload bestand'.</li>
                                <li>Klik op de bestandsnaam, hij opent in een nieuw venster.</li>
                                <li>Kopieer de URL die in de balk bovenaan verschijnt.</li>
                                <li>Voer deze in als hyperlink aan je campagnetekst.</li>
                            </ul>
                        </header>
                        <article class="public-files">
                            <ul>
                                <template is="dom-repeat" items="[[publicFiles.files]]">
                                    <can-api
                                        auth
                                        auto="[[signedIn]]"
                                        access-token="{{accessToken}}"
                                        api-endpoint="[[apiEndpoint]]"
                                        route="entrepreneurs/[[slug]]/publicfiles/[[item.fileNameEncoded]]"
                                        method="DELETE"
                                        last-response="{{publicFiles}}"
                                        id="publicFile[[index]]"
                                        >
                                    </can-api>


                                    <li>
                                        <a href$="[[item.url]]" title$="[[item.fileName]]" target="_blank">[[item.fileName]]</a>
                                        <can-button remove multiple on-tap="_deletePublicFile" data-file-name="[[item.fileName]]"></can-button>
                                    </li>
                                </template>
                            </ul>
                        </article>
                        <footer>
                            <can-file-io
                                disabled$="[[disabled]]"
                                disabled-warning="[[disabledWarning]]"
                                api-route="entrepreneurs/[[slug]]/publicfiles"
                                user-id="[[campaignId]]"
                                download-data="{{publicFiles}}"
                                on-upload-failed="_uploadFailed"
                                select-button-label="upload bestand"
                                maximum-file-size="{{maximumFileSize}}"
                                method="POST"
                            ></can-file-io>
                        </footer>
                    </can-card>

                    <h2>Bouw het fundament van je campagne. Hoeveel heb je nodig? Hoe lang wil je erover doen?</h2>

                    <can-card>
                        <header>
                            <h3>Doelbedragen</h3>
                            <p>Hoeveel wil je minimaal én maximaal crowdfunden met je campagne?</p>
                        </header>
                        <article>

                            <can-form
                                auth
                                disabled$="[[!editable]]"
                                disabled-warning="[[notEditableWarning]]"
                                apipath="entrepreneurs/[[campaign.id]]/requiredandmaxfunding"
                                id="requiredandmaxfunding-form"
                                formdata="[[campaign]]"
                                method="PUT"
                                valid="{{goalsCompleted}}"
                                on-response="_updateCampaignData"
                                >

                                <can-textinput
                                    name="requiredFunding"
                                    type="number"
                                    value="{{campaign.requiredFunding}}"
                                    placeholder="minimaal... (€)"
                                    min="5"
                                    pattern="([0-9])+"
                                    required>
                                </can-textinput>

                                <can-textinput
                                    name="maxFunding"
                                    type="number"
                                    value="{{campaign.maxFunding}}"
                                    placeholder="...en maximaal (€)"
                                    pattern="([0-9])+"
                                    description="Denk goed na over je maximale bedrag. Je moet een duidelijk plan hebben voor het geld dat je extra ophaalt. Let op: bij een leningcampagne kan het maximale bedrag niet hoger zijn dan tweemaal het minimumbedrag."
                                    min="{{campaign.requiredFunding}}"
                                    max="{{maxRequiredFunding}}"
                                    required>
                                </can-textinput>

                            </can-form>

                        </article>

                    </can-card>

                    <can-card id="dates">
                        <header>
                            <h3>Campagnedata</h3>
                            <p>Op basis van onderstaande gegevens geven we je informatie over je aflossingsdata en -bedragen</p>
                        </header>

                        <article>

                            <can-form
                                auth
                                disabled$="[[!editable]]"
                                disabled-warning="[[notEditableWarning]]"
                                formdata="{{campaign}}"
                                apipath="entrepreneurs/[[campaign.id]]/datesinterest"
                                id="dates-interest-form"
                                method="PUT"
                                valid="{{datesCompleted}}"
                                on-response="_updateCampaignData"
                                >

                                <can-textinput
                                    name="endDate"
                                    type="date"
                                    date-format="YYYY-MM-DD"
                                    min="[[today]]"
                                    max="2099-12-31"
                                    value="{{campaign.endDate}}"
                                    placeholder="einddatum van je campagne"
                                    required
                                ></can-textinput>

                                <template is="dom-if" if="[[isLening]]">

                                    <template is="dom-if" if="[[!isYearlyLoan]]">

                                        <can-selectbox
                                            name="annuity"
                                            value="{{campaign.annuity}}"
                                            placeholder="hoe wil je aflossen?"
                                            options="{{annuityItems}}"
                                            required
                                        ></can-selectbox>

                                    </template>

                                    <template is="dom-if" if="[[paysInTerms]]">

                                        <can-textinput
                                            name="firstPaymentDate"
                                            type="date"
                                            date-format="YYYY-MM-DD"
                                            min="[[campaign.endDate]]"
                                            max="[[campaign.finalPaymentDate]]"
                                            value="{{campaign.firstPaymentDate}}"
                                            placeholder="wanneer begin je met aflossen?"
                                            required="[[paysInTerms]]"
                                        ></can-textinput>

                                    </template>

                                    <can-textinput
                                        name="finalPaymentDate"
                                        type="date"
                                        date-format="YYYY-MM-DD"
                                        min="[[campaign.firstPaymentDate]]"
                                        max="2099-12-31"
                                        value="{{campaign.finalPaymentDate}}"
                                        placeholder="wanneer eindig je met aflossen?"
                                        required
                                    ></can-textinput>

                                    <can-textinput
                                        name="totalInterest"
                                        value="{{campaign.returnOnInvestmentPercentage}}"
                                        placeholder$="[[totalInterestLabel]]"
                                        step="0.1"
                                        pattern="^\d{1,3}(?:\.\d)?$"
                                        required
                                    ></can-textinput>

                                </template>

                            </can-form>

                        </article>

                        <template is="dom-if" if="[[isLening]]">

                            <footer>
                                <can-campaign-repayments-card
                                    campaign-id="[[campaign.id]]"
                                    amounts="[[repaymentAmounts]]"
                                /></can-campaign-repayments-card>
                            </footer>

                        </template>

                    </can-card>

                    <can-card>
                        <header>
                            <h3>Investeersdersbedragen</h3>
                            <p>Wat zijn de minimale én maximale bedragen die een persoon per keer kan investeren?</p>
                        </header>
                        <article>

                            <caas-campaign-types
                                auto-download="[[campaign.id]]"
                                campaign-types="{{campaignTypes}}"
                                api-endpoint="[[apiEndpoint]]"
                                campaign-id="[[campaign.id]]"
                                access-token="[[accessToken]]"
                                response-status="{{campaignTypesResponseStatus}}">
                            </caas-campaign-types>

                            <can-form
                                use-with-caas
                                disabled$="[[!editable]]"
                                disabled-warning="[[notEditableWarning]]"
                                id="requiredFunding-form"
                                valid="{{investAmountsCompleted}}"
                                response-status="[[campaignTypesResponseStatus]]"
                                on-caas-submit="_saveCampaignTypes">

                                <template is="dom-repeat" items="{{campaignTypes}}" index-as="index">

                                    <can-textinput
                                    name="minInvestment"
                                    type="number"
                                    value="{{item.minimumInvestment::change}}"
                                    placeholder="minimaal... [[item.contractTypeName]] (€)"
                                    min="5"
                                    max="80000"
                                    pattern="([0-9])+">
                                    </can-textinput>

                                    <can-textinput
                                    name="maxInvestment"
                                    type="number"
                                    value="{{item.maximumInvestment::change}}"
                                    placeholder="... en maximaal [[item.contractTypeName]] (€)"
                                    description="Het minimale bedrag is €5, het maximale €80000."
                                    min="[[item.minimumInvestment]]"
                                    max="80000"
                                    pattern="([0-9])+">
                                    </can-textinput>

                                    <template is="dom-if" if="[[isAandelen]]">

                                        <can-textinput
                                            name="investIncrements"
                                            type="number"
                                            value="{{item.investmentIncrement::change}}"
                                            placeholder="Emissiewaarde (€)"
                                            pattern="([0-9])+"
                                            description="Dit is de waarde van 1 aandeel"
                                            min="{{item.minimumInvestment}}"
                                            max="{{item.maximumInvestment}}"
                                            required>
                                        </can-textinput>

                                    </template>

                                </template>

                            </can-form>

                        </article>

                    </can-card>

                    <template is="dom-if" if="[[isAandelen]]">

                        <can-card>
                            <header>
                                <h3>Aandelen</h3>
                                <p>Vul hier de emissie waarde van 1 aandeel in.</p>
                                <p>Het aantal te verstrekken aandelen is: doelbedrag / waarde 1 aandeel.</p>
                            </header>
                            <article>

                                <can-form
                                    auth
                                    disabled$="[[!editable]]"
                                    disabled-warning="[[notEditableWarning]]"
                                    apipath="entrepreneurs/[[campaign.id]]/certificatepassingdate"
                                    id="certificatepassingdate-form"
                                    formdata="[[campaign]]"
                                    method="PUT"
                                    valid="{{certificatePassingDateCompleted}}"
                                    on-response="_updateCampaignData"
                                    >

                                    <can-textinput
                                        name="certificatePassingDate"
                                        type="date"
                                        date-format="YYYY-MM-DD"
                                        min="2016-01-01"
                                        max="2099-12-31"
                                        value="{{campaign.certificatePassingDate}}"
                                        description="De dag van de waarheid"
                                        placeholder="Passeerdatum van de certificaten?"
                                    ></can-textinput>

                                </can-form>

                            </article>

                        </can-card>
                    </template>


                    <h2>Vul hier de gegevens van jouw onderneming in.</h2>

                    <can-card>
                        <header>
                            <h3>Jouw onderneming</h3>
                        </header>
                        <article>

                            <can-user-profile-form
                                user-id="[[slug]]"
                                role="ondernemer"
                                disabled$="[[!editable]]"
                                disabled-warning="[[notEditableWarning]]"
                                is-stocks-campaign="[[isAandelen]]"
                            ></can-user-profile-form>

                        </article>
                    </can-card>

                    <can-card>
                        <header>
                            <h3>Kopie ID</h3>
                            <p>Upload hier een digitale kopie van je paspoort, identiteitskaart of rijbewijs (maximum [[maximumIDFileSize]] KB)</p>
                        </header>
                        <article>
                            <can-campaign-id-form
                                disabled$="[[!editable]]"
                                disabled-warning="[[notEditableWarning]]"
                                campaign-id="[[campaign.id]]"
                                valid="{{campaignIdComplete}}"
                                maximum-file-size="{{maximumIDFileSize}}"
                            ></can-campaign-id-form>
                        </article>

                    </can-card>

                    <can-card>
                        <header>
                            <h3>KVK uittreksel</h3>
                            <p>Upload hier een digitaal KVK uittreksel (maximum [[maximumKvkFileSize]] KB)</p>
                        </header>
                        <article>
                            <can-campaign-kvk-form
                                disabled$="[[!editable]]"
                                disabled-warning="[[notEditableWarning]]"
                                campaign-id="[[campaign.id]]"
                                valid="{{campaignKvkComplete}}"
                                maximum-file-size="{{maximumKvkFileSize}}"
                            ></can-campaign-kvk-form>
                        </article>

                    </can-card>

                    <can-card>
                        <header>
                            <h3>Overeenkomst</h3>
                            <ul>
                                <li>
                                    <template is="dom-if" if="[[isLening]]">
                                        <a href="https://assets.crowdaboutnow.nl/pdf/leningovereenkomst_CAN_ondernemer_V3.pdf" target="_blank">Stap 1: Download de overeenkomst</a>
                                    </template>
                                    <template is="dom-if" if="[[!isLening]]">
                                        <a href="https://assets.crowdaboutnow.nl/pdf/voorverkoopoverkeenkomst_CAN_ondernemer_V3.pdf" target="_blank">Stap 1: Download de overeenkomst</a>
                                    </template>
                                </li>
                                <li>Stap 2: Print, vul in en onderteken</li>
                                <li>Stap 3: Scan de overeenkomst (duidelijk leesbaar!)</li>
                                <li>Stap 4: Upload je getekende overeenkomst (als jpg, maximum [[maximumContractFileSize]] KB)</li>
                            </ul>
                        </header>
                        <article>
                            <can-campaign-contract-form
                                disabled$="[[!editable]]"
                                disabled-warning="[[notEditableWarning]]"
                                campaign-id="[[campaign.id]]"
                                valid="{{campaignContractComplete}}"
                                maximum-file-size="{{maximumContractFileSize}}"
                            ></can-campaign-contract-form>
                        </article>

                    </can-card>


                    <h2>Hoe ga je je supporters bedanken?</h2>
                    <can-campaign-incentives-form
                        campaign-started="[[campaign.started]]"
                        disabled$="[[!editable]]"
                        disabled-warning="[[notEditableWarning]]"
                        campaignid="[[campaign.id]]"
                        contract-type-ids="[[campaign.contractTypeIds]]"
                        campaign-minimum="[[campaign.minInvestment]]"
                        campaign-maximum="[[campaign.maxInvestment]]"
                        valid="{{incentivesComplete}}"
                    ></can-campaign-incentives-form>

                    <h2>Hier zie je alle investeerders en hoe je met ze in contact komt.</h2>

                    <can-card expandable>


                        <can-api
                            download-file
                            auth
                            access-token="{{accessToken}}"
                            api-endpoint="[[apiEndpoint]]"
                            content-type="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                            id="export-excel"
                            downloaded-filename="contracts.xlsx"
                            route="entrepreneurs/[[slug]]/contracts/export/excel"
                            on-response="_excelDownloadSuccess"
                            method="GET"
                            loading="{{loadingExcel}}">
                        </can-api>

                        <header>Hier download je een overzicht van al je investeerders</header>

                        <article>
                            <can-button on-tap="_getExportExcel" hidden$="[[loadingExcel]]">Excel</can-button>
                            <can-loader hidden$="[[!loadingExcel]]" small>
                                <h4>Bezig met laden. Een ogenblik a.u.b.</h4>
                            </can-loader>
                        </article>


                        <footer>

                        </footer>

                    </can-card>

                    <can-contracts-table campaign-id="[[campaign.id]]">
                    </can-contracts-table>

        </section>

        <aside>
            <can-sidebar>
                <can-campaign-stats-card
                    campaign-id="[[campaign.id]]"
                    contract-type-id="[[activeContractId]]"
                ></can-campaign-stats-card>


                <can-card
                    expanded
                    hidden$="[[!campaignTypes.1]]">
                    <header>
                        <h3>Combinatie overzicht:</h3>
                        <template is="dom-repeat" items="[[campaignTypes]]" index-as="index">
                            <h4>Totaal [[item.contractTypeName]]: <can-number euros="[[item.progress]]"></can-number></h4>
                        </template>
                    </header>
                </can-card>


                <can-card expandable expanded>
                    <header>
                        <h3>Campagnestatus</h3>
                        <h4 hidden$="[[!campaign.started]]">Campagne loopt!</h4>
                        <h4 hidden$="[[campaign.started]]">[[campaignStatusLabel]]</h4>
                    </header>
                    <article>
                        <can-button
                            is="pushstate-anchor"
                            url="/campagnes/[[campaign.id]]"
                            target="_blank"
                            >
                            campagne bekijken
                        </can-button>
                    </article>
                </can-card>

                <can-card>

                    <can-api
                        auth
                        auto="[[signedIn]]"
                        access-token="{{accessToken}}"
                        api-endpoint="[[apiEndpoint]]"
                        route="entrepreneurs/[[slug]]/administrativeformalities"
                        method="GET"
                        last-response="{{administrativeFormalities}}"
                        >
                    </can-api>

                    <header>
                        <h3>Campagne formaliteiten</h3>
                        <p>Onze financiële administratie houdt bij waaraan voldaan is.</p>
                    </header>
                    <article class="administrativeFormalities">
                        <ul>
                            <li completed$="[[administrativeFormalities.contractDocumentReceived]]">contract goedgekeurd</li>
                            <li completed$="[[administrativeFormalities.identificationDocumentReceived]]">ID goedgekeurd</li>
                            <li completed$="[[administrativeFormalities.KVKDocumentReceived]]">KvK uittreksel ontvangen</li>
                            <li completed$="[[administrativeFormalities.paymentReceived]]">factuur betaald</li>
                            <li completed$="[[administrativeFormalities.basicCampaignInformationApproved]]">basisgegevens goedgekeurd</li>
                        </ul>
                    </article>
                </can-card>

                <can-campaign-location-card
                    address="[[campaign.address]]"
                    geocode="[[campaign.geocode]]">
                        <can-button on-tap="openLocationSelector" small>Wijzig</can-button></p>
                </can-campaign-location-card>

            </can-sidebar>
        </aside>

    </can-page>

    <can-overlay
        id="location-selector-overlay"
        with-backdrop
        no-cancel-on-outside-click
        no-cancel-on-esc-key>

        <can-api
            auth
            access-token="{{accessToken}}"
            api-endpoint="[[apiEndpoint]]"
            id="update-campaign-geocode"
            content-type="application/json"
            body="{{campaign}}"
            route="entrepreneurs/[[campaign.id]]/geocode"
            method="PUT"
            on-response="geoCodeSaved"
            on-error="geoCodeSavedError">
        </can-api>

        <can-location-selector
            geocode="{{campaign.geocode}}"
        ></can-location-selector>


        <can-button on-tap="saveGeocode">Opslaan</can-button>
        <can-button small on-tap="requestCloseLocationSelector">annuleren</can-button>
    </can-overlay>

    <can-overlay
        id="campaign-text-overlay"
        with-backdrop
        no-cancel-on-outside-click
        no-cancel-on-esc-key
        >

        <can-loader hidden$="[[!savingInterviewText]]"></can-loader>


        <can-api
            auth
            access-token="{{accessToken}}"
            api-endpoint="[[apiEndpoint]]"
            id="update-campaign-text"
            content-type="application/json"
            body='{"interview": "[[htmlInterview]]"}'
            route="entrepreneurs/[[campaign.id]]/campaigntext"
            on-request="saveInterviewText"
            on-response="interviewTextSaved"
            on-error="interviewTextSavedError"
            method="PUT">
        </can-api>

        <silk-editor
            disabled="[[savingInterviewText]]"
            resize-images
            paste-plain-text
            fixed-formatting-bar
            max-image-height="800"
            max-image-width="800"
            max-image-size="1000"
            content="[[campaign.interview]]"
            on-content-change="_handleCampaignText"
            formatting-options="bold,italics,h3,unorderedlist,orderedlist,link,image,underline,vimeo,youtube"
        ></silk-editor>
        <can-button on-tap="saveCampaignText">Opslaan</can-button>
        <can-button small on-tap="requestCloseTextEditor">annuleren</can-button>
    </can-overlay>

    </template>

  </template>

  <script>
    Polymer({

      is: 'placetobe-campaign-dashboard',
      behaviors: [CaasAuthBehavior],

      properties: {
        apiEndpoint: {
          type: String,
          value: null
        },

        userId: {
          type: String
        },

        signedIn: {
          type: Boolean,
          value: false
        },
        accessToken: {
            type: String,
            value: window.localStorage.getItem('CanSessionToken')
        },
        campaign: {
            type: Object,
            notify: true
        },
        activeContractId: {
            type: String,
            notify: true,
            computed: '_getActiveContractId(campaign.contractTypeIds)'
        },
        basicsCompleted: {
            type: Boolean,
            value: false
        },
        categoriesCompleted: {
            type: Boolean,
            value: false
        },
        videoCompleted: {
            type: Boolean,
            value: false
        },
        coverCompleted: {
            type: Boolean,
            value: false
        },
        socialCompleted: {
            type: Boolean,
            value: false
        },
        tabOneCompleted: {
            type: Boolean,
            computed: '_tabOneIsComplete(basicsCompleted, categoriesCompleted, videoCompleted, coverCompleted, socialCompleted)'
        },
        goalsCompleted: {
            type: Boolean,
            value: false
        },
        datesCompleted: {
            type: Boolean,
            value: false
        },
        investAmountsCompleted: {
            type: Boolean,
            value: false
        },
        tabTwoComplete: {
            type: Boolean,
            computed: '_tabTwoIsComplete(goalsCompleted, datesCompleted, investAmountsCompleted)'
        },
        campaignIdComplete: {
            type: Boolean,
            value: false
        },
        campaignContractComplete: {
            type: Boolean,
            value: false
        },
        campaignKvkComplete: {
            type: Boolean,
            value: false
        },
        tabThreeComplete: {
            type: Boolean,
            computed: '_tabThreeIsComplete(campaignIdComplete, campaignContractComplete, campaignKvkComplete)'
        },
        incentivesComplete: {
            type: Boolean
        },
        tabFourComplete: {
            type: Boolean,
            computed: '_tabFourIsComplete(incentivesComplete)'
        },
        percentageCompleted: {
            type: Number,
            computed: '_computePercentageCompleted(basicsCompleted, categoriesCompleted, videoCompleted, coverCompleted, socialCompleted, goalsCompleted, datesCompleted, investAmountsCompleted, campaignIdComplete, campaignKvkComplete, campaignContractComplete, incentivesComplete, administrativeFormalities.contractDocumentReceived, administrativeFormalities.identificationDocumentReceived, administrativeFormalities.KVKDocumentReceived, administrativeFormalities.paymentReceived, administrativeFormalities.basicCampaignInformationApproved)'
        },
        userId: {
            type: String,
            value: null
        },
        isLening: {
            type: Boolean,
            notify: true,
            computed: '_computeIsLening(campaign.contractTypeIds)'
        },
        isAandelen: {
            type: Boolean,
            notify: true,
            computed: '_computeIsAandelen(campaign.contractTypeIds)'
        },
        paysInTerms: {
            type: Boolean,
            notify: true,
            computed: '_computePayInTerms(campaign.annuity)'
        },
        annuityItems: {
            type: Object,
            notify: true,
            value: [
                { name : 'In 1 keer', value : 0},
                { name : '3 maandelijks', value : 3},
                { name : 'Half jaarlijks', value : 6},
                { name : 'Jaarlijks', value : 12}
            ]
        },
        maxRequiredFunding: {
            type: Number,
            computed: '_getMaxRequiredFunding(campaign.requiredFunding, isLening)'
        },

        today: {
            type: String,
            value: function() {
                return moment().format('YYYY-MM-DD');
            }
        },
        campaignStatusLabel: {
            type: String,
            computed: '_getCampaignStatusLabel(campaign.status)'
        },
        activeTab: {
            type: Number,
            value: 0
        },
        editable: {
            type: Boolean,
            computed: '_computeIfIsEditable(campaign.entrepreneurCanEdit, campaign.started, userRole)',
            value: false
        },

        notEditableWarning: {
            type: String,
            computed: '_computeNotEditableWarning(campaign.entrepreneurCanEdit, campaign.started)'
        },
        htmlInterview: {
            type: String,
            value: null
        },

        loggedIn: {
            type: Boolean,
            notify: true,
            value: false
        },
        userRole: {
            type: String,
            value: null
        },
        editorEnabled: {
            type: Boolean,
            value: false,
            computed: '_computeEditorIsEnabled(userRole)'
        },
        savingInterviewText: {
            type: Boolean,
            value: false
        },
        administrativeFormalities: {
            type: Object,
            value: {}
        },

        repaymentAmounts: {
            type: Array,
            computed: '_getRepaymentAmounts(campaign.requiredFunding, campaign.maxFunding)'
        },
        loadingExcel: {
            type: Boolean,
            value: false
        },
        tabsdata: Array,
        maximumFileSize: Number,
        maximumCoverFileSize: Number,
        maximumIDFileSize: Number,
        maximumContractFileSize: Number,
        maximumKvkFileSize: Number,
        disabled: Boolean,
        disabledWarning: String,
        campaignId: Number,
        totalInterestLabel: {
            type: String,
            computed: '_computeTotalInterestLabel(activeContractId)'
        },
        isYearlyLoan: {
            type: Boolean,
            computed: '_computeIfLoanIsOnlyYearly(campaign.contractTypeIds, isLening)'
        }
      },
      observers: [
        '_parseFacebookURL(campaign.facebook)',
        '_parseTwitterURL(campaign.twitter)',
        '_parseLinkedInURL(campaign.linkedin)',
        '_setCampaignText(campaign.interview)',
        '_setVideo(campaign.video.url)',
        '_setUserParameters(_tokenData.data.*)'
      ],

      _setUserParameters: function (tokenDataChange) {
        this.userId = this._tokenData.data.userId;
      },
      ready: function () {
          window.scrollTo(0, 0);
          this.addEventListener('image-upload-error', function(e) {
              alert(e.detail);
          });
      },

      _computeIsLening: function(contractTypeIds) {
          if(!contractTypeIds) return;
          return (contractTypeIds.indexOf(3) != -1 || contractTypeIds.indexOf(4) != -1 || contractTypeIds.indexOf(7)  != -1 || contractTypeIds.indexOf(8) != -1);
      },

      _computeIsAandelen: function(contractTypeIds) {
          if(!contractTypeIds) return;
          return (contractTypeIds.indexOf(5) != -1 || contractTypeIds.indexOf(6) != -1);
      },

      _computeIfLoanIsOnlyYearly: function(contractTypeIds, isLening) {
          if(!contractTypeIds) return;
          if(!isLening) return false;
          return (contractTypeIds.indexOf(7) != -1 || contractTypeIds.indexOf(8) != -1);
      },

      _computePayInTerms: function(annuity) {
          return (annuity != 0);
      },

      _getActiveContractId: function(contractTypeIds) {
          return (contractTypeIds) ? contractTypeIds[0] : null;
      },

      handleBasicsError: function() {
      },

      _tabOneIsComplete: function(basicsCompleted, categoriesCompleted, videoCompleted, coverCompleted, socialCompleted) {
          return (basicsCompleted && categoriesCompleted && videoCompleted && coverCompleted && socialCompleted);
      },

      _tabTwoIsComplete: function(goalsCompleted, datesCompleted, investAmountsCompleted) {
          return (goalsCompleted && datesCompleted && investAmountsCompleted);
      },

      _tabThreeIsComplete: function(campaignIdComplete, campaignContractComplete, campaignKvkComplete) {
          return (campaignIdComplete, campaignContractComplete, campaignKvkComplete);
      },

      _tabFourIsComplete: function(incentivesComplete) {
          return ((!!incentivesComplete));
      },

      _computePercentageCompleted: function(basicsCompleted, categoriesCompleted, videoCompleted, coverCompleted, socialCompleted, goalsCompleted, datesCompleted, investAmountsCompleted, campaignIdComplete, campaignKvkComplete, campaignContractComplete, incentivesComplete, contractDocumentReceived, identificationDocumentReceived, KVKDocumentReceived, paymentReceived, basicCampaignInformationApproved) {
          var numberOfCompletes = 0;
          var completables = [basicsCompleted, categoriesCompleted, videoCompleted, coverCompleted, socialCompleted, goalsCompleted, datesCompleted, investAmountsCompleted, campaignIdComplete, campaignKvkComplete, campaignContractComplete, incentivesComplete, contractDocumentReceived, identificationDocumentReceived, KVKDocumentReceived, paymentReceived, basicCampaignInformationApproved];

          for (var i = 0; i < completables.length; i++) {
              if(completables[i]) numberOfCompletes++;
          }
          return (numberOfCompletes * 100) / completables.length;
      },

      _parseFacebookURL: function(facebookURL) {
          if(!facebookURL) return;
          this.set('campaign.facebook', this._parseSocialURL(facebookURL));
      },

      _parseTwitterURL: function(twitterURL) {
          if(!twitterURL) return;
          this.set('campaign.twitter', this._parseSocialURL(twitterURL));
      },

      _parseLinkedInURL: function(linkedInURL) {
          if(!linkedInURL) return;
          this.set('campaign.linkedin', this._parseSocialURL(linkedInURL));
      },

      _parseSocialURL: function(socialURL) {
          return socialURL.replace(/\?.*?$/, '');
      },

      _getMaxRequiredFunding: function(requiredFunding, isLening) {
          return (isLening) ? (requiredFunding * 2) : '';
      },

      _getCampaignStatusLabel: function(campaignStatus) {
          switch(campaignStatus) {
          case 0:
              return 'in voorbereiding';
          case 1:
              return 'lopend';
          case 2:
          case 3:
          case 4:
              return 'succesvol';
          default:
              return 'afgerond';
          }
      },
      _handleCampaignText: function(e, interviewText) {
          this.set('htmlInterview', interviewText.replace(/"/g, '\\"'));
      },

      saveCampaignText: function() {
          this.$$('#update-campaign-text').send();
      },

      openTextEditor: function() {
          this.set('htmlInterview', this.campaign.interview.replace(/"/g, '\\"'));
          this.$$('can-overlay#campaign-text-overlay').open();
      },

      requestCloseTextEditor: function() {
          var close = window.confirm('Weet je zeker dat je de editor wilt verlaten? Eventuele wijzigingen gaan mogelijk verloren.');
          if(close) {
              this.closeTextEditor();
          }
      },

      closeTextEditor: function() {
          this.$$('can-overlay#campaign-text-overlay').close();
      },

      saveGeocode: function() {
          this.$$('#update-campaign-geocode').send();
      },

      openLocationSelector: function() {
          this.set('htmlInterview', this.campaign.interview.replace(/"/g, '\\"'));
          this.$$('can-overlay#location-selector-overlay').open();
      },

      requestCloseLocationSelector: function() {
          var close = window.confirm('Weet je zeker dat je de locatie selectie wilt verlaten? Eventuele wijzigingen gaan mogelijk verloren.');
          if(close) {
              this.closeLocationSelector();
          }
      },

      closeLocationSelector: function() {
          this.$$('can-overlay#location-selector-overlay').close();
      },

      geoCodeSaved: function() {
          this.closeLocationSelector();
      },

      geoCodeSavedError: function() {
          alert('Sorry, er is iets misgegaan tijdens het bewaren van de locatie. Probeer het opnieuw a.u.b.');
      },

      _computeNotEditableWarning: function(entrepreneurCanEdit, campaignStarted) {
          if(campaignStarted) return 'Je kunt deze informatie niet wijzigen omdat je campagne is gestart.';
          if(!entrepreneurCanEdit) return 'Je kunt deze informatie (nog) niet wijzigen.';
          return 'Deze campagne is gesloten';
      },

      _computeIfIsEditable: function (entrepreneurCanEdit, started, userRole) {
          if(userRole == 'accountmanager') return true;
          if(userRole == 'financialadministrator') return true;
          if(started) return false;
          if(entrepreneurCanEdit) return true;
          return false;
      },

      _computeEditorIsEnabled: function(userRole) {
          if(userRole == 'accountmanager') return true;
          if(userRole == 'financialadministrator') return true;
          return false;
      },

      _getExportExcel: function() {
          this.set('loadingExcel', true);
          this.$$('#export-excel').send();
      },

      _excelDownloadSuccess: function() {
          this.set('loadingExcel', false);
      },

      _setCampaignText: function(campaignInterview) {
          this.$$('#campaignText').innerHTML = campaignInterview;
      },
      saveInterviewText: function() {
          this.savingInterviewText = true;
      },
      interviewTextSaved: function() {
          this.savingInterviewText = false;
          this.set('campaign.interview', this.htmlInterview.replace(/\\"/g, '"'));
          this.closeTextEditor();
      },
      interviewTextSavedError: function() {
          alert('Sorry, er is iets misgegaan tijdens het bewaren van de tekst. Probeer het opnieuw a.u.b.');
          this.savingInterviewText = false;
      },

      _setVideo: function(campaignVideoURL) {
          if(!campaignVideoURL) return;
          var pattern = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/g;
          var youtubeID = campaignVideoURL.replace(pattern, '$7');

          if(campaignVideoURL.match(pattern)) {

              this.set('campaign.video.vimeo', {});
              this.notifyPath('campaign.video.vimeo', {});

              this.set('campaign.video.youtube', {id: youtubeID});
              this.notifyPath('campaign.video.youtube', {id: youtubeID});

              return;
          }

          pattern = /^.*?\/([0-9]{3,12})$/;
          var vimeoID = campaignVideoURL.replace(pattern, '$1');

          if(campaignVideoURL.match(pattern)) {

              this.set('campaign.video.youtube', {});
              this.notifyPath('campaign.video.youtube', {});

              this.set('campaign.video.vimeo', {id: vimeoID});
              this.notifyPath('campaign.video.vimeo', {id: vimeoID});

          }

      },

      _updateCampaignData: function() {
          this.$$('can-campaign-stats-card').updateStatsData();
          this.$$('caas-campaign-types').getItems();
          if(this.isLening) this.$$('can-campaign-repayments-card').updatePaymentData();
      },

      _getRepaymentAmounts: function(requiredFunding, maxFunding) {
          return [Number(maxFunding), Number(requiredFunding)];
      },

      _deletePublicFile: function(evt) {
          if (confirm('Weet je zeker dat je ' + evt.model.item.fileName + ' wilt verwijderen?')) {
              this.$$('#publicFile' + evt.model.index).send();
          } else {
              return;
          }
      },

      _computeTotalInterestLabel: function(activeContractId) {
          if(activeContractId == 7 || activeContractId == 8) return 'jaarrendement (%)';
          return 'rendement over de gehele periode (%)';
      },

      updateCampaignData: function() {
          this.$$('#campaignAjax').send();
      },

      _saveCampaignTypes: function() {
          var campaignTypes = this.campaignTypes;
          for (var i = 0; i < campaignTypes.length; i++) {
              this.$$('caas-campaign-types').notifyPath('campaignTypes.' + [i] + '.id');
          }
      }

    });
  </script>
</dom-module>
